(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{585:function(s,e,t){"use strict";t.r(e);var a=t(9),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("今天找到一个不错的方案，可以解决无法在外网访问大内网（多层NAT）里服务器的方案——进行内网穿透。有了这个方案就可以访问内网的各种服务比如SMB媒体服务器，或者进行远程开发。\n")]),s._v(" "),t("h2",{attrs:{id:"需求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[s._v("#")]),s._v(" 需求")]),s._v(" "),t("p",[s._v("在外网（非内网）环境下，对内网服务进行访问。比如：可以在图书馆或者教室，连接着校园网，来远程访问宿舍里树莓派和开发服务器来看视频、远程备份甚至进行远程开发。")]),s._v(" "),t("h2",{attrs:{id:"方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方案"}},[s._v("#")]),s._v(" 方案")]),s._v(" "),t("p",[s._v("需要达成以上需求，需要将大内网（多层NAT）下的主机上的服务转发出去，也就是进行内网穿透。如果拥有公网IP，则在路由器上设置端口映射即可。但宿舍的网络属于多层NAT，根本无法实现。故寻找一种开源的，低开销的解决方案。")]),s._v(" "),t("p",[s._v("经过几番搜寻研究，找到了一个名为"),t("a",{attrs:{href:"https://github.com/fatedier/frp",target:"_blank",rel:"noopener noreferrer"}},[s._v("frp"),t("OutboundLink")],1),s._v("的用Go语言开发的开源项目。")]),s._v(" "),t("p",[s._v("个人对该项目的理解为：")]),s._v(" "),t("ol",[t("li",[s._v("选取一个符合条件的（一般为带宽足够）、具有公网IP的主机（一般为Linux服务器）作为服务端。")]),s._v(" "),t("li",[s._v("选取内网任意一个主机作为客户端。")]),s._v(" "),t("li",[s._v("在内网主机（客户端）与公网IP主机（服务端）之间预先建立主动连接，然后对特定端口的服务进行转发。")]),s._v(" "),t("li",[s._v("可以理解为一种代理，或者是将端口映射的步骤分配到了两个主机。渗透测试中的反弹shell+内网平行渗透看起来和这个也很像。")])]),s._v(" "),t("h2",{attrs:{id:"安装与配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装与配置"}},[s._v("#")]),s._v(" 安装与配置")]),s._v(" "),t("p",[s._v("先去项目的"),t("a",{attrs:{href:"https://github.com/fatedier/frp/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("Releases"),t("OutboundLink")],1),s._v("页面下载可执行文件和相关配置文件。")]),s._v(" "),t("p",[s._v("我服务端的机器是x86架构的，所以选择"),t("code",[s._v("AMD64")]),s._v("，内网客户端是一个树莓派，所以选择"),t("code",[s._v("ARM64")]),s._v("的。")]),s._v(" "),t("p",[s._v("分别下载到两台服务器的任意目录后，进行解压，然后进入目录：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf frpxxxxxxx.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" frpxxxxxx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"服务端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务端"}},[s._v("#")]),s._v(" 服务端")]),s._v(" "),t("p",[s._v("在服务端服务器进入目录后，找到"),t("code",[s._v("frps.ini")]),s._v("进行编辑（"),t("code",[s._v("frps")]),s._v("中的"),t("code",[s._v("s")]),s._v("意为server，同理"),t("code",[s._v("frpc")]),s._v("中的"),t("code",[s._v("c")]),s._v("意为customer）")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[common]\nbind_port = 7000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("这里设置的端口号"),t("code",[s._v("7000")]),s._v("为客户端服务器连接到服务端服务器时使用的端口，可以为任意未占用端口。")]),s._v(" "),t("h3",{attrs:{id:"客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),t("p",[s._v("现在再去客户端进行配置，编辑"),t("code",[s._v("frpc.ini")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[common]\nserver_addr = x.x.x.x\nserver_port = 7000\n\n[ssh]\ntype = tcp\nlocal_ip = 127.0.0.1\nlocal_port = 22\nremote_port = 6000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("这里"),t("code",[s._v("server_addr")]),s._v("字段的值为服务端服务器的公网IP地址，一般可以在服务器控制页面找到。\n"),t("code",[s._v("local_ip")]),s._v("和"),t("code",[s._v("local_port")]),s._v("的值为该服务在内网中的IP和端口，如：\nssh是本机服务，就选取回环地址"),t("code",[s._v("127.0.0.1")]),s._v("，如在内网其他主机上，择填写内网其他主机的内网IP地址（如"),t("code",[s._v("192,168.1.xxx")]),s._v("）。\n"),t("code",[s._v("remote_port")]),s._v("字段为该本地服务将要准发到服务端的哪一个端口（或者说在访问远端的哪一个端口时可以被转发到该本地服务。此例中：访问远端ip地址+6000端口，即可访问该本地主机的22端口，即ssh服务。也就是说：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" user@x.x.x.x -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("就可以通过ssh控制本地服务器。\n同理，可以对SMB、ftp、web等服务进行一一配置。也可以顺便实现负载均衡等操作。详情可以参考"),t("a",{attrs:{href:"https://gofrp.org/docs/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),t("OutboundLink")],1)]),s._v(" "),t("h3",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),t("p",[s._v("通过 ./frps -c ./frps.ini 启动服务端，再通过 ./frpc -c ./frpc.ini 启动客户端。\n观察没有报错，就可以尝试用上文ssh命令进行测试连接。")]),s._v(" "),t("h3",{attrs:{id:"开机启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开机启动"}},[s._v("#")]),s._v(" 开机启动")]),s._v(" "),t("p",[s._v("因为我的两台服务器都使用"),t("code",[s._v("systemd")]),s._v("进行管理，而且解压文件中有现成的"),t("code",[s._v(".service")]),s._v("配置文件，所以这里简单介绍一下：")]),s._v(" "),t("ol",[t("li",[s._v("先进入"),t("code",[s._v("systemd")]),s._v("目录，找到对应的文件进行编辑（比如服务端就编辑"),t("code",[s._v("frps.service")]),s._v("）:\n将"),t("code",[s._v("ExecStart")]),s._v("字段的可执行文件以及配置文件路径改为自己实际的"),t("code",[s._v("绝对路径")]),s._v("。")]),s._v(" "),t("li",[s._v("然后将该文件拷贝到"),t("code",[s._v("/lib/systemd/system/")]),s._v("目录下")]),s._v(" "),t("li",[s._v("然后启动、开机启动、查看状态：")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start frps\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" frps\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl status frps\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("如果状态为 "),t("code",[s._v("active (running)")]),s._v("则表示成功。")])]),s._v(" "),t("h2",{attrs:{id:"注意的点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注意的点"}},[s._v("#")]),s._v(" 注意的点")]),s._v(" "),t("ol",[t("li",[s._v("如果无法访问服务器的7000或者其他端口，可以去服务器控制页面，对防火墙或者安全组进行配置，对特定IP和端口进行放行。（有时配置完需要重启实例）")]),s._v(" "),t("li",[s._v("可以提前将可执行文件放到自己想要的目录，比如"),t("code",[s._v("/opt")]),s._v("下。")]),s._v(" "),t("li",[s._v("不仅可以通过此方法访问一台内网主机，也可以将内网客户端主机作为二次跳板，访问其他内网主机的服务。（多次转发）")]),s._v(" "),t("li",[s._v("可以配置DNS来隐藏IP。")])]),s._v(" "),t("h2",{attrs:{id:"写在后面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#写在后面"}},[s._v("#")]),s._v(" 写在后面")]),s._v(" "),t("p",[s._v("其实frp还有很多很多可以拓展应用的地方，等以后在慢慢研究。这次虽然只是一个简单的项目部署和配置，但确实用非常实惠的方法（用的aws的免费服务器）解决了一个长期困扰我的难题：无法在复杂网络环境下访问内网资源。")]),s._v(" "),t("h3",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ol",[t("li",[s._v("frp的文档：https://gofrp.org/docs/features/")]),s._v(" "),t("li",[s._v("frp开源地址：https://github.com/fatedier/frp")])])])}),[],!1,null,null,null);e.default=r.exports}}]);